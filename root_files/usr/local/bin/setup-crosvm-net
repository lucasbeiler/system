#!/bin/sh
set -e

# Load tun module
modprobe tun

# Get username. # TODO: Get users dinamically or find another way to setup.
user=$(getent passwd 1000 | cut -d: -f1)

# Create TAP interface if it does not exist. # TODO: Verify if 192.168.10.1/24 is not used by other interfaces.
if ! ip link show crosvm_tap >/dev/null 2>&1; then
    ip tuntap add mode tap user $user vnet_hdr crosvm_tap
fi
if ! ip addr show crosvm_tap | grep -q '192.168.10.1/24'; then
    ip addr add 192.168.10.1/24 dev crosvm_tap
fi
ip link set crosvm_tap up

# Enable IPv4 forwarding
sysctl -w net.ipv4.ip_forward=1 >/dev/null

# Use wlan0 as the outbound interface. TODO: Expand and/or detect others automatically. This is fine for now because I use a laptop.
OUT_IF=wlan0

# Add NAT for outbound traffic
iptables -t nat -C POSTROUTING -o "$OUT_IF" -j MASQUERADE 2>/dev/null || \
iptables -t nat -A POSTROUTING -o "$OUT_IF" -j MASQUERADE

# Allow forwarding from wlan0 to crosvm_tap and vice versa
iptables -C FORWARD -i "$OUT_IF" -o crosvm_tap -m state --state RELATED,ESTABLISHED -j ACCEPT 2>/dev/null || \
iptables -A FORWARD -i "$OUT_IF" -o crosvm_tap -m state --state RELATED,ESTABLISHED -j ACCEPT

iptables -C FORWARD -i crosvm_tap -o "$OUT_IF" -j ACCEPT 2>/dev/null || \
iptables -A FORWARD -i crosvm_tap -o "$OUT_IF" -j ACCEPT